name: PR æ£€æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR éªŒè¯
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´å†å²ä»¥ä¾¿è¿›è¡Œå·®å¼‚åˆ†æ
        fetch-depth: 0

    - name: è®¾ç½® Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ç¼“å­˜ Gradle ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: æˆäºˆ gradlew æ‰§è¡Œæƒé™
      run: chmod +x gradlew

    - name: æ£€æŸ¥ PR æ ‡é¢˜æ ¼å¼
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          chore
          ci
          build
        requireScope: false
        subjectPattern: ^(?![A-Z]).+$
        subjectPatternError: |
          ä¸»é¢˜å¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä¸èƒ½ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚
          ä¾‹å¦‚: "feat: æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½" è€Œä¸æ˜¯ "feat: æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½"

    - name: è¿è¡Œå®Œæ•´ä»£ç æ£€æŸ¥
      run: ./gradlew clean codeQuality

    - name: æ£€æŸ¥ä»£ç è¦†ç›–ç‡
      run: ./gradlew jacocoTestCoverageVerification

    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      id: jacoco
      uses: madrapps/jacoco-report@v1.6.1
      with:
        paths: |
          ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 80
        min-coverage-changed-files: 80
        title: ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
        update-comment: true

    - name: æ£€æŸ¥ TODO/FIXME æ³¨é‡Š
      run: |
        if grep -r "TODO\|FIXME" src/main/java/ --exclude-dir=target; then
          echo "âš ï¸ å‘ç° TODO æˆ– FIXME æ³¨é‡Šï¼Œè¯·åœ¨æäº¤å‰å¤„ç†ï¼š"
          grep -rn "TODO\|FIXME" src/main/java/ --exclude-dir=target || true
          echo "å¦‚æœè¿™äº›æ³¨é‡Šæ˜¯æœ‰æ„ä¿ç•™çš„ï¼Œè¯·åœ¨PRæè¿°ä¸­è¯´æ˜åŸå› ã€‚"
        else
          echo "âœ… æœªå‘ç°å¾…å¤„ç†çš„ TODO æˆ– FIXME æ³¨é‡Š"
        fi

    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
        SENSITIVE_PATTERNS="password|secret|token|key|credential|api_key"
        if grep -ri "$SENSITIVE_PATTERNS" src/ --exclude-dir=target --exclude="*.class" | grep -v "// è¿™æ˜¯ç¤ºä¾‹" | grep -v "# é…ç½®ç¤ºä¾‹"; then
          echo "âš ï¸ å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ï¼š"
          grep -rin "$SENSITIVE_PATTERNS" src/ --exclude-dir=target --exclude="*.class" | grep -v "// è¿™æ˜¯ç¤ºä¾‹" | grep -v "# é…ç½®ç¤ºä¾‹" || true
          echo "è¯·ç¡®ä¿æ²¡æœ‰ç¡¬ç¼–ç çš„å¯†ç ã€å¯†é’¥æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯ã€‚"
          exit 1
        else
          echo "âœ… æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯"
        fi

  architecture-tests:
    name: æ¶æ„æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ç¼“å­˜ Gradle ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: æˆäºˆ gradlew æ‰§è¡Œæƒé™
      run: chmod +x gradlew

    - name: è¿è¡Œæ¶æ„æµ‹è¯•
      run: ./gradlew test --tests="*ArchitectureTest"
